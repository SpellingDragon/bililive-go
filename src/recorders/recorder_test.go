package recorders

import (
	"context"
	"net/url"
	"testing"
	"time"

	"github.com/hr3lxphr6j/bililive-go/src/configs"
	"github.com/hr3lxphr6j/bililive-go/src/live"
	"github.com/hr3lxphr6j/bililive-go/src/live/bilibili"
)

func TestBiliLive(t *testing.T) {
	// mock := "{\"code\":0,\"message\":\"0\",\"ttl\":1,\"data\":{\"room_id\":21547895,\"short_id\":0,\"uid\":441381282,\"is_hidden\":false,\"is_locked\":false,\"is_portrait\":false,\"live_status\":1,\"hidden_till\":0,\"lock_till\":0,\"encrypted\":false,\"pwd_verified\":true,\"live_time\":1685880050,\"room_shield\":1,\"all_special_types\":[50],\"playurl_info\":{\"conf_json\":\"{\\\"cdn_rate\\\":10000,\\\"report_interval_sec\\\":150}\",\"playurl\":{\"cid\":21547895,\"g_qn_desc\":[{\"qn\":30000,\"desc\":\"杜比\",\"hdr_desc\":\"\",\"attr_desc\":null},{\"qn\":20000,\"desc\":\"4K\",\"hdr_desc\":\"\",\"attr_desc\":null},{\"qn\":10000,\"desc\":\"原画\",\"hdr_desc\":\"\",\"attr_desc\":null},{\"qn\":400,\"desc\":\"蓝光\",\"hdr_desc\":\"HDR\",\"attr_desc\":null},{\"qn\":250,\"desc\":\"超清\",\"hdr_desc\":\"HDR\",\"attr_desc\":null},{\"qn\":150,\"desc\":\"高清\",\"hdr_desc\":\"\",\"attr_desc\":null},{\"qn\":80,\"desc\":\"流畅\",\"hdr_desc\":\"\",\"attr_desc\":null}],\"stream\":[{\"protocol_name\":\"http_stream\",\"format\":[{\"format_name\":\"flv\",\"codec\":[{\"codec_name\":\"avc\",\"current_qn\":150,\"accept_qn\":[10000,400,250,150],\"base_url\":\"/live-bvc/575508/live_441381282_66012500_1500.flv?\",\"url_info\":[{\"host\":\"https://xy61x160x48x41xy.mcdn.bilivideo.cn:486\",\"extra\":\"expires=1685888608\\u0026pt=web\\u0026deadline=1685888608\\u0026len=0\\u0026oi=1902923078\\u0026platform=web\\u0026qn=0\\u0026trid=10009e886254f3fe4d82a2efc200330330a9\\u0026uipk=100\\u0026uipv=100\\u0026nbs=1\\u0026uparams=cdn,deadline,len,oi,platform,qn,trid,uipk,uipv,nbs\\u0026cdn=cn-gotcha16\\u0026upsig=aca5e0205020ec3339e8d2b5af12ad9d\\u0026sk=1304f646dfeb4df8b6e7ff33c167d3adda26bb4da5f21f1459ebf5b3c7780c72\\u0026p2p_type=1\\u0026sl=5\\u0026free_type=0\\u0026mid=602310692\\u0026sid=mcdn-jkwl-jswx-ct-2002788\\u0026chash=1\\u0026sche=ban\\u0026score=12\\u0026pp=rtmp\\u0026source=onetier\\u0026trace=90\\u0026site=59f5c83c5c2aab4aafc1e39c5c9bb382\\u0026order=1\",\"stream_ttl\":3600},{\"host\":\"https://cn-jsnt-ct-01-03.bilivideo.com\",\"extra\":\"expires=1685888608\\u0026pt=web\\u0026deadline=1685888608\\u0026len=0\\u0026oi=1902923078\\u0026platform=web\\u0026qn=0\\u0026trid=10009e886254f3fe4d82a2efc200330330a9\\u0026uipk=100\\u0026uipv=100\\u0026nbs=1\\u0026uparams=cdn,deadline,len,oi,platform,qn,trid,uipk,uipv,nbs\\u0026cdn=cn-gotcha01\\u0026upsig=c8118a55717c49992949dfec6bb3ccb1\\u0026sk=1304f646dfeb4df8b6e7ff33c167d3adda26bb4da5f21f1459ebf5b3c7780c72\\u0026p2p_type=1\\u0026sl=5\\u0026free_type=0\\u0026mid=602310692\\u0026sid=cn-jsnt-ct-01-03\\u0026chash=1\\u0026sche=ban\\u0026score=12\\u0026pp=rtmp\\u0026source=onetier\\u0026trace=890\\u0026site=59f5c83c5c2aab4aafc1e39c5c9bb382\\u0026order=2\",\"stream_ttl\":3600}],\"hdr_qn\":null,\"dolby_type\":0,\"attr_name\":\"\"},{\"codec_name\":\"hevc\",\"current_qn\":250,\"accept_qn\":[250],\"base_url\":\"/live-bvc/575508/live_441381282_66012500_minihevc.flv?\",\"url_info\":[{\"host\":\"https://xy49x86x255x20xy.mcdn.bilivideo.cn:486\",\"extra\":\"expires=1685888608\\u0026pt=web\\u0026deadline=1685888608\\u0026len=0\\u0026oi=1902923078\\u0026platform=web\\u0026qn=0\\u0026trid=10009e886254f3fe4d82a2efc200330330a9\\u0026uipk=100\\u0026uipv=100\\u0026nbs=1\\u0026uparams=cdn,deadline,len,oi,platform,qn,trid,uipk,uipv,nbs\\u0026cdn=cn-gotcha16\\u0026upsig=ff4c97bc9e3eac91100af86b36e4d069\\u0026sk=1304f646dfeb4df8b6e7ff33c167d3adda26bb4da5f21f1459ebf5b3c7780c72\\u0026p2p_type=1\\u0026sl=5\\u0026free_type=0\\u0026mid=602310692\\u0026sid=mcdn-jkwl-jsyz-ct-2002405\\u0026chash=1\\u0026sche=ban\\u0026score=14\\u0026pp=rtmp\\u0026source=onetier\\u0026trace=90\\u0026site=59f5c83c5c2aab4aafc1e39c5c9bb382\\u0026order=1\",\"stream_ttl\":3600},{\"host\":\"https://cn-jsnt-ct-01-05.bilivideo.com\",\"extra\":\"expires=1685888608\\u0026pt=web\\u0026deadline=1685888608\\u0026len=0\\u0026oi=1902923078\\u0026platform=web\\u0026qn=0\\u0026trid=10009e886254f3fe4d82a2efc200330330a9\\u0026uipk=100\\u0026uipv=100\\u0026nbs=1\\u0026uparams=cdn,deadline,len,oi,platform,qn,trid,uipk,uipv,nbs\\u0026cdn=cn-gotcha01\\u0026upsig=d41d97100bcc78072b8a4f17a1df6189\\u0026sk=1304f646dfeb4df8b6e7ff33c167d3adda26bb4da5f21f1459ebf5b3c7780c72\\u0026p2p_type=1\\u0026sl=5\\u0026free_type=0\\u0026mid=602310692\\u0026sid=cn-jsnt-ct-01-05\\u0026chash=1\\u0026sche=ban\\u0026score=14\\u0026pp=rtmp\\u0026source=onetier\\u0026trace=890\\u0026site=59f5c83c5c2aab4aafc1e39c5c9bb382\\u0026order=2\",\"stream_ttl\":3600}],\"hdr_qn\":null,\"dolby_type\":0,\"attr_name\":\"\"}]}]},{\"protocol_name\":\"http_hls\",\"format\":[{\"format_name\":\"ts\",\"codec\":[{\"codec_name\":\"avc\",\"current_qn\":150,\"accept_qn\":[10000,400,250,150],\"base_url\":\"/live-bvc/575508/live_441381282_66012500_1500.m3u8?\",\"url_info\":[{\"host\":\"https://d1--cn-gotcha101.bilivideo.com\",\"extra\":\"expires=1685888608\\u0026len=0\\u0026oi=1902923078\\u0026pt=web\\u0026qn=0\\u0026trid=10039e886254f3fe4d82a2efc200330330a9\\u0026sigparams=cdn,expires,len,oi,pt,qn,trid\\u0026cdn=cn-gotcha01\\u0026sign=34cc54008c02d3a04f0ceb65a4502ab2\\u0026sk=1304f646dfeb4df8b6e7ff33c167d3adda26bb4da5f21f1459ebf5b3c7780c72\\u0026p2p_type=1\\u0026sl=5\\u0026free_type=0\\u0026mid=602310692\\u0026pp=rtmp\\u0026source=onetier\\u0026trace=10\\u0026site=59f5c83c5c2aab4aafc1e39c5c9bb382\\u0026order=1\",\"stream_ttl\":3600}],\"hdr_qn\":null,\"dolby_type\":0,\"attr_name\":\"\"}]},{\"format_name\":\"fmp4\",\"codec\":[{\"codec_name\":\"avc\",\"current_qn\":150,\"accept_qn\":[10000,400,250,150],\"base_url\":\"/live-bvc/575508/live_441381282_66012500_1500/index.m3u8?\",\"url_info\":[{\"host\":\"https://xy61x160x48x41xy.mcdn.bilivideo.cn:486\",\"extra\":\"expires=1685888608\\u0026len=0\\u0026oi=1902923078\\u0026pt=web\\u0026qn=0\\u0026trid=10079e886254f3fe4d82a2efc200330330a9\\u0026sigparams=cdn,expires,len,oi,pt,qn,trid\\u0026cdn=cn-gotcha16\\u0026sign=d842f1e3d0fc50f3d70d80e32987ab8d\\u0026sk=657866af8fc16d8b2b84dfdde3e98143a3dc308b223ddad3e3e2f65932188943\\u0026flvsk=1304f646dfeb4df8b6e7ff33c167d3adda26bb4da5f21f1459ebf5b3c7780c72\\u0026p2p_type=1\\u0026sl=5\\u0026free_type=0\\u0026mid=602310692\\u0026sid=mcdn-jkwl-jswx-ct-2002788\\u0026chash=1\\u0026sche=ban\\u0026bvchls=1\\u0026score=12\\u0026pp=rtmp\\u0026source=onetier\\u0026trace=90\\u0026site=59f5c83c5c2aab4aafc1e39c5c9bb382\\u0026order=1\",\"stream_ttl\":3600},{\"host\":\"https://cn-jsnt-ct-01-03.bilivideo.com\",\"extra\":\"expires=1685888608\\u0026len=0\\u0026oi=1902923078\\u0026pt=web\\u0026qn=0\\u0026trid=10079e886254f3fe4d82a2efc200330330a9\\u0026sigparams=cdn,expires,len,oi,pt,qn,trid\\u0026cdn=cn-gotcha01\\u0026sign=1c0cad572132afb815fa5687b89d1bff\\u0026sk=657866af8fc16d8b2b84dfdde3e98143a3dc308b223ddad3e3e2f65932188943\\u0026flvsk=1304f646dfeb4df8b6e7ff33c167d3adda26bb4da5f21f1459ebf5b3c7780c72\\u0026p2p_type=1\\u0026sl=5\\u0026free_type=0\\u0026mid=602310692\\u0026sid=cn-jsnt-ct-01-03\\u0026chash=1\\u0026sche=ban\\u0026bvchls=1\\u0026score=12\\u0026pp=rtmp\\u0026source=onetier\\u0026trace=890\\u0026site=59f5c83c5c2aab4aafc1e39c5c9bb382\\u0026order=2\",\"stream_ttl\":3600},{\"host\":\"https://d1--cn-gotcha208.bilivideo.com\",\"extra\":\"expires=1685888608\\u0026len=0\\u0026oi=1902923078\\u0026pt=web\\u0026qn=0\\u0026trid=10079e886254f3fe4d82a2efc200330330a9\\u0026sigparams=cdn,expires,len,oi,pt,qn,trid\\u0026cdn=cn-gotcha208\\u0026sign=363320d4ac6c7f3ec1c55b35794c57d5\\u0026sk=657866af8fc16d8b2b84dfdde3e98143a3dc308b223ddad3e3e2f65932188943\\u0026p2p_type=1\\u0026sl=5\\u0026free_type=0\\u0026mid=602310692\\u0026pp=rtmp\\u0026source=onetier\\u0026trace=10\\u0026site=59f5c83c5c2aab4aafc1e39c5c9bb382\\u0026order=3\",\"stream_ttl\":3600}],\"hdr_qn\":null,\"dolby_type\":0,\"attr_name\":\"\"},{\"codec_name\":\"hevc\",\"current_qn\":250,\"accept_qn\":[250],\"base_url\":\"/live-bvc/575508/live_441381282_66012500_minihevc/index.m3u8?\",\"url_info\":[{\"host\":\"https://xy49x86x255x20xy.mcdn.bilivideo.cn:486\",\"extra\":\"expires=1685888608\\u0026len=0\\u0026oi=1902923078\\u0026pt=web\\u0026qn=0\\u0026trid=10079e886254f3fe4d82a2efc200330330a9\\u0026sigparams=cdn,expires,len,oi,pt,qn,trid\\u0026cdn=cn-gotcha16\\u0026sign=6f8327999aa2300d67d1dbedbf13e21c\\u0026sk=657866af8fc16d8b2b84dfdde3e98143a3dc308b223ddad3e3e2f65932188943\\u0026flvsk=1304f646dfeb4df8b6e7ff33c167d3adda26bb4da5f21f1459ebf5b3c7780c72\\u0026p2p_type=1\\u0026sl=5\\u0026free_type=0\\u0026mid=602310692\\u0026sid=mcdn-jkwl-jsyz-ct-2002405\\u0026chash=1\\u0026sche=ban\\u0026bvchls=1\\u0026score=14\\u0026pp=rtmp\\u0026source=onetier\\u0026trace=90\\u0026site=59f5c83c5c2aab4aafc1e39c5c9bb382\\u0026order=1\",\"stream_ttl\":3600},{\"host\":\"https://cn-jsnt-ct-01-05.bilivideo.com\",\"extra\":\"expires=1685888608\\u0026len=0\\u0026oi=1902923078\\u0026pt=web\\u0026qn=0\\u0026trid=10079e886254f3fe4d82a2efc200330330a9\\u0026sigparams=cdn,expires,len,oi,pt,qn,trid\\u0026cdn=cn-gotcha01\\u0026sign=8f834b9a351f6f68149afd93911c6f18\\u0026sk=657866af8fc16d8b2b84dfdde3e98143a3dc308b223ddad3e3e2f65932188943\\u0026flvsk=1304f646dfeb4df8b6e7ff33c167d3adda26bb4da5f21f1459ebf5b3c7780c72\\u0026p2p_type=1\\u0026sl=5\\u0026free_type=0\\u0026mid=602310692\\u0026sid=cn-jsnt-ct-01-05\\u0026chash=1\\u0026sche=ban\\u0026bvchls=1\\u0026score=14\\u0026pp=rtmp\\u0026source=onetier\\u0026trace=890\\u0026site=59f5c83c5c2aab4aafc1e39c5c9bb382\\u0026order=2\",\"stream_ttl\":3600},{\"host\":\"https://d1--cn-gotcha208.bilivideo.com\",\"extra\":\"expires=1685888608\\u0026len=0\\u0026oi=1902923078\\u0026pt=web\\u0026qn=0\\u0026trid=10079e886254f3fe4d82a2efc200330330a9\\u0026sigparams=cdn,expires,len,oi,pt,qn,trid\\u0026cdn=cn-gotcha208\\u0026sign=fcf6e0cb7bd57529171ce163a51c1043\\u0026sk=657866af8fc16d8b2b84dfdde3e98143a3dc308b223ddad3e3e2f65932188943\\u0026p2p_type=1\\u0026sl=5\\u0026free_type=0\\u0026mid=602310692\\u0026pp=rtmp\\u0026source=onetier\\u0026trace=10\\u0026site=59f5c83c5c2aab4aafc1e39c5c9bb382\\u0026order=3\",\"stream_ttl\":3600}],\"hdr_qn\":null,\"dolby_type\":0,\"attr_name\":\"\"}]}]}],\"p2p_data\":{\"p2p\":true,\"p2p_type\":1,\"m_p2p\":true,\"m_servers\":[\"https://xy49x86x255x20xy.mcdn.bilivideo.cn:486\"]},\"dolby_qn\":null}},\"official_type\":0,\"official_room_id\":0}}"
	// fmt.Printf("stream rsp:%s", mock)
	rawURL, _ := url.Parse("https://live.bilibili.com/21452505")
	blive := &bilibili.Live{
		BaseLive: live.BaseLive{
			Url:           rawURL,
			LastStartTime: time.Time{},
			Options: &live.Options{
				Quality: 150,
			},
		},
		RealID: "21452505",
	}
	simpleRecorder := &SimpleRecorder{
		Live:       blive,
		OutPutPath: "",
		Config:     configs.NewConfig(),
	}
	simpleRecorder.TryRecord(context.Background())
}
